// lib/mauritian-documents-generator.ts - Version amÃ©liorÃ©e avec ordonnances basÃ©es sur le diagnostic

export class MauritianDocumentsGenerator {
  static generateMauritianDocuments(
    consultationReport: any,
    doctorInfo: any,
    patientData: any,
    diagnosisData: any
  ) {
    console.log('ðŸš€ Generating Mauritian documents with diagnosis data:', diagnosisData)
    
    const currentDate = new Date().toLocaleDateString('fr-FR')
    
    // 1. Generate consultation report
    const consultation = this.generateConsultationReport(
      consultationReport.consultationData,
      doctorInfo,
      currentDate
    )
    
    // 2. Generate biology prescriptions based on diagnosis
    const biology = this.generateBiologyPrescription(
      patientData,
      diagnosisData,
      doctorInfo,
      currentDate
    )
    
    // 3. Generate paraclinical prescriptions based on diagnosis
    const paraclinical = this.generateParaclinicalPrescription(
      patientData,
      diagnosisData,
      doctorInfo,
      currentDate
    )
    
    // 4. Generate medication prescriptions based on diagnosis
    const medication = this.generateMedicationPrescription(
      patientData,
      diagnosisData,
      doctorInfo,
      currentDate
    )
    
    return {
      consultation,
      biology,
      paraclinical,
      medication
    }
  }

  // 1. CONSULTATION REPORT (unchanged)
  static generateConsultationReport(consultationData: any, doctorInfo: any, date: string) {
    return {
      header: {
        title: "COMPTE-RENDU DE CONSULTATION MÃ‰DICALE",
        doctorName: doctorInfo.fullName,
        specialty: doctorInfo.specialty,
        address: doctorInfo.address,
        city: doctorInfo.city,
        phone: doctorInfo.phone,
        email: doctorInfo.email,
        registrationNumber: doctorInfo.registrationNumber,
        date: date,
        time: new Date().toLocaleTimeString('fr-FR')
      },
      patient: {
        firstName: consultationData.patientInfo.firstName,
        lastName: consultationData.patientInfo.lastName,
        age: consultationData.patientInfo.age,
        gender: consultationData.patientInfo.gender,
        address: consultationData.patientInfo.address,
        phone: consultationData.patientInfo.phone,
        allergies: consultationData.patientInfo.allergies,
        weight: consultationData.patientInfo.weight,
        height: consultationData.patientInfo.height,
        bmi: consultationData.patientInfo.bmi
      },
      anamnesis: `
MOTIF DE CONSULTATION:
${consultationData.chiefComplaint}

HISTOIRE DE LA MALADIE:
${consultationData.diseaseHistory}

SYMPTÃ”MES RAPPORTÃ‰S:
${consultationData.symptoms?.join(', ') || 'Non spÃ©cifiÃ©s'}

DURÃ‰E DES SYMPTÃ”MES:
${consultationData.symptomDuration || 'Non prÃ©cisÃ©e'}
      `.trim(),
      physicalExam: consultationData.examination || 'Examen clinique complet effectuÃ©',
      diagnosticAssessment: `
DIAGNOSTIC PRINCIPAL:
${consultationData.diagnosis} (Confiance: ${consultationData.diagnosticConfidence}%)

RAISONNEMENT DIAGNOSTIQUE:
${consultationData.diagnosticReasoning || 'BasÃ© sur l\'anamnÃ¨se et l\'examen clinique'}

DIAGNOSTICS DIFFÃ‰RENTIELS:
${consultationData.differentialDiagnoses?.map((d: any) => 
  `- ${d.condition} (${d.confidence}%)`
).join('\n') || 'Aucun'}
      `.trim(),
      therapeuticPlan: consultationData.treatment || 'Plan thÃ©rapeutique dÃ©taillÃ© ci-dessous',
      followUp: consultationData.followUpPlan || 'Suivi selon Ã©volution',
      signature: {
        physician: doctorInfo.fullName,
        date: date
      }
    }
  }

  // 2. BIOLOGY PRESCRIPTIONS - Based on diagnosis
  static generateBiologyPrescription(
    patientData: any,
    diagnosisData: any,
    doctorInfo: any,
    date: string
  ) {
    const prescriptions = []
    
    // Extract lab tests from diagnosis data
    if (diagnosisData?.suggestedExams?.lab && diagnosisData.suggestedExams.lab.length > 0) {
      diagnosisData.suggestedExams.lab.forEach((exam: any) => {
        prescriptions.push({
          exam: exam.name || exam,
          indication: exam.indication || `Pour ${diagnosisData.diagnosis?.primary?.condition || 'diagnostic'}`,
          urgency: exam.urgency || "Dans les 48h",
          fasting: exam.fasting || this.determineFastingRequirement(exam.name),
          mauritianAvailability: this.getMauritianLabAvailability(exam.name)
        })
      })
    } else {
      // Default lab tests based on diagnosis
      prescriptions.push(...this.getDefaultLabTests(diagnosisData))
    }
    
    return {
      header: {
        title: "ORDONNANCE D'EXAMENS BIOLOGIQUES",
        subtitle: "Prescription for Laboratory Tests",
        physician: doctorInfo.fullName,
        registration: doctorInfo.registrationNumber,
        date: date,
        validity: "Valable 3 mois"
      },
      patient: {
        firstName: patientData.firstName,
        lastName: patientData.lastName,
        age: patientData.age,
        gender: Array.isArray(patientData.gender) ? patientData.gender[0] : patientData.gender,
        idNumber: patientData.idNumber || "Ã€ complÃ©ter"
      },
      prescriptions,
      instructions: {
        general: "Examens Ã  rÃ©aliser dans un laboratoire agrÃ©Ã©",
        preparation: "Respecter les conditions de prÃ©lÃ¨vement indiquÃ©es",
        results: "RÃ©sultats Ã  communiquer au mÃ©decin prescripteur"
      }
    }
  }

  // 3. PARACLINICAL PRESCRIPTIONS - Based on diagnosis
  static generateParaclinicalPrescription(
    patientData: any,
    diagnosisData: any,
    doctorInfo: any,
    date: string
  ) {
    const prescriptions = []
    
    // Extract imaging tests from diagnosis data
    if (diagnosisData?.suggestedExams?.imaging && diagnosisData.suggestedExams.imaging.length > 0) {
      diagnosisData.suggestedExams.imaging.forEach((exam: any) => {
        prescriptions.push({
          exam: exam.name || exam,
          category: this.determineImagingCategory(exam.name),
          indication: exam.indication || `Ã‰valuation ${diagnosisData.diagnosis?.primary?.condition || 'diagnostique'}`,
          urgency: exam.urgency || "Dans la semaine",
          preparation: exam.preparation || this.getImagingPreparation(exam.name),
          mauritianAvailability: this.getMauritianImagingCenters(exam.name)
        })
      })
    } else {
      // Default imaging based on diagnosis
      prescriptions.push(...this.getDefaultImagingTests(diagnosisData))
    }
    
    // Add other paraclinical exams if needed
    if (diagnosisData?.suggestedExams?.other) {
      diagnosisData.suggestedExams.other.forEach((exam: any) => {
        prescriptions.push({
          exam: exam.name || exam,
          category: "Exploration fonctionnelle",
          indication: exam.indication || "ComplÃ©ment diagnostic",
          urgency: "ProgrammÃ©",
          preparation: exam.preparation || "Aucune",
          mauritianAvailability: "Centres spÃ©cialisÃ©s"
        })
      })
    }
    
    return {
      header: {
        title: "ORDONNANCE D'EXAMENS PARACLINIQUES",
        subtitle: "Prescription for Medical Imaging & Functional Tests",
        physician: doctorInfo.fullName,
        registration: doctorInfo.registrationNumber,
        date: date,
        validity: "Valable 3 mois"
      },
      patient: {
        firstName: patientData.firstName,
        lastName: patientData.lastName,
        age: patientData.age,
        gender: Array.isArray(patientData.gender) ? patientData.gender[0] : patientData.gender,
        weight: patientData.weight + " kg",
        allergies: patientData.allergies?.join(', ') || 'Aucune'
      },
      prescriptions,
      specialInstructions: {
        contrast: prescriptions.some(p => p.exam.includes('Scanner') || p.exam.includes('IRM')) 
          ? "VÃ©rifier crÃ©atinine si injection de produit de contraste"
          : null,
        pregnancy: "Signaler toute grossesse en cours ou suspectÃ©e",
        metalImplants: prescriptions.some(p => p.exam.includes('IRM'))
          ? "Signaler tout implant mÃ©tallique ou pacemaker"
          : null
      }
    }
  }

  // 4. MEDICATION PRESCRIPTIONS - Based on diagnosis treatment plan
  static generateMedicationPrescription(
    patientData: any,
    diagnosisData: any,
    doctorInfo: any,
    date: string
  ) {
    const prescriptions = []
    
    // Extract medications from treatment plan
    if (diagnosisData?.treatmentPlan?.medications && diagnosisData.treatmentPlan.medications.length > 0) {
      diagnosisData.treatmentPlan.medications.forEach((med: any) => {
        prescriptions.push({
          dci: med.name || med.dci,
          brand: med.brand || this.getMauritianBrand(med.name),
          class: med.class || this.getMedicationClass(med.name),
          dosage: med.dosage || "Ã€ adapter",
          frequency: med.frequency || "Selon prescription",
          duration: med.duration || "Selon Ã©volution",
          totalQuantity: this.calculateQuantity(med),
          indication: med.indication || diagnosisData.diagnosis?.primary?.condition,
          administration: med.route || "Voie orale",
          specialInstructions: med.instructions || this.getMedicationInstructions(med.name)
        })
      })
    } else {
      // Generate default medications based on diagnosis
      prescriptions.push(...this.getDefaultMedications(diagnosisData))
    }
    
    // Add symptomatic treatments if needed
    if (diagnosisData?.symptoms || diagnosisData?.diagnosis?.primary?.symptoms) {
      prescriptions.push(...this.getSymptomaticTreatments(diagnosisData))
    }
    
    return {
      header: {
        title: "ORDONNANCE MÃ‰DICAMENTEUSE",
        subtitle: "Medical Prescription / Prescription MÃ©dicale",
        physician: doctorInfo.fullName,
        registration: doctorInfo.registrationNumber,
        date: date,
        validity: "Ordonnance valable 1 mois sauf mention contraire",
        renewability: "Non renouvelable sauf mention"
      },
      patient: {
        firstName: patientData.firstName,
        lastName: patientData.lastName,
        age: patientData.age,
        gender: Array.isArray(patientData.gender) ? patientData.gender[0] : patientData.gender,
        weight: patientData.weight + " kg",
        allergies: patientData.allergies?.join(', ') || 'AUCUNE ALLERGIE CONNUE'
      },
      prescriptions,
      clinicalAdvice: {
        hydration: "Maintenir une bonne hydratation (1.5-2L/jour)",
        activity: diagnosisData?.treatmentPlan?.recommendations?.find((r: string) => 
          r.toLowerCase().includes('repos') || r.toLowerCase().includes('activitÃ©')
        ) || "ActivitÃ© selon tolÃ©rance",
        diet: diagnosisData?.treatmentPlan?.recommendations?.find((r: string) => 
          r.toLowerCase().includes('rÃ©gime') || r.toLowerCase().includes('alimentation')
        ) || "Alimentation Ã©quilibrÃ©e",
        followUp: diagnosisData?.followUp?.nextVisit || "Revoir si pas d'amÃ©lioration dans 72h",
        emergency: "Si aggravation des symptÃ´mes, consulter en urgence",
        additionalRecommendations: diagnosisData?.treatmentPlan?.recommendations || []
      }
    }
  }

  // HELPER METHODS

  static determineFastingRequirement(examName: string): string {
    const fastingExams = ['glycÃ©mie', 'cholestÃ©rol', 'triglycÃ©rides', 'bilan lipidique']
    return fastingExams.some(exam => examName.toLowerCase().includes(exam))
      ? "Ã€ jeun 12h"
      : "Non Ã  jeun"
  }

  static getMauritianLabAvailability(examName: string): string {
    const commonExams = ['NFS', 'CRP', 'glycÃ©mie', 'crÃ©atinine', 'ASAT', 'ALAT']
    if (commonExams.some(exam => examName.includes(exam))) {
      return "Tous laboratoires (Lancet, BioMed, City Clinic Lab)"
    }
    return "Laboratoires spÃ©cialisÃ©s - Se renseigner"
  }

  static getDefaultLabTests(diagnosisData: any): any[] {
    const condition = diagnosisData?.diagnosis?.primary?.condition?.toLowerCase() || ''
    const tests = []
    
    // Common baseline tests
    tests.push({
      exam: "NFS (NumÃ©ration Formule Sanguine)",
      indication: "Bilan de base",
      urgency: "48h",
      fasting: "Non Ã  jeun",
      mauritianAvailability: "Tous laboratoires"
    })
    
    tests.push({
      exam: "CRP (ProtÃ©ine C-RÃ©active)",
      indication: "Recherche syndrome inflammatoire",
      urgency: "48h",
      fasting: "Non Ã  jeun",
      mauritianAvailability: "Tous laboratoires"
    })
    
    // Condition-specific tests
    if (condition.includes('diabÃ¨te') || condition.includes('glyc')) {
      tests.push({
        exam: "GlycÃ©mie Ã  jeun + HbA1c",
        indication: "Ã‰valuation diabÃ¨te",
        urgency: "48h",
        fasting: "Ã€ jeun 12h",
        mauritianAvailability: "Tous laboratoires"
      })
    }
    
    if (condition.includes('cardiaque') || condition.includes('cÅ“ur') || condition.includes('angine')) {
      tests.push({
        exam: "Troponine I",
        indication: "Marqueur cardiaque",
        urgency: "URGENT",
        fasting: "Non Ã  jeun",
        mauritianAvailability: "Urgences hospitaliÃ¨res"
      })
      
      tests.push({
        exam: "BNP ou NT-proBNP",
        indication: "Insuffisance cardiaque",
        urgency: "24h",
        fasting: "Non Ã  jeun",
        mauritianAvailability: "Laboratoires spÃ©cialisÃ©s"
      })
    }
    
    if (condition.includes('infection') || condition.includes('fiÃ¨vre')) {
      tests.push({
        exam: "HÃ©mocultures x2",
        indication: "Recherche bactÃ©riÃ©mie",
        urgency: "URGENT avant antibiotiques",
        fasting: "Non Ã  jeun",
        mauritianAvailability: "HÃ´pitaux et cliniques"
      })
    }
    
    return tests
  }

  static determineImagingCategory(examName: string): string {
    if (examName.toLowerCase().includes('radio') || examName.toLowerCase().includes('rx')) {
      return "Radiologie conventionnelle"
    } else if (examName.toLowerCase().includes('scanner') || examName.toLowerCase().includes('ct')) {
      return "TomodensitomÃ©trie"
    } else if (examName.toLowerCase().includes('irm') || examName.toLowerCase().includes('mri')) {
      return "Imagerie par rÃ©sonance magnÃ©tique"
    } else if (examName.toLowerCase().includes('Ã©cho') || examName.toLowerCase().includes('doppler')) {
      return "Ã‰chographie"
    }
    return "Imagerie mÃ©dicale"
  }

  static getImagingPreparation(examName: string): string {
    if (examName.toLowerCase().includes('abdomin')) {
      return "Ã€ jeun 6h, vessie pleine"
    } else if (examName.toLowerCase().includes('pelvi')) {
      return "Vessie pleine (boire 1L d'eau 1h avant)"
    } else if (examName.toLowerCase().includes('scanner') && examName.toLowerCase().includes('thorax')) {
      return "Pas de prÃ©paration particuliÃ¨re"
    }
    return "Selon protocole du centre"
  }

  static getMauritianImagingCenters(examName: string): string {
    if (examName.toLowerCase().includes('irm')) {
      return "Apollo Bramwell, Wellkin, City Clinic"
    } else if (examName.toLowerCase().includes('scanner')) {
      return "Tous hÃ´pitaux privÃ©s et publics"
    } else if (examName.toLowerCase().includes('radio')) {
      return "Tous centres de radiologie"
    }
    return "Centres d'imagerie agrÃ©Ã©s"
  }

  static getDefaultImagingTests(diagnosisData: any): any[] {
    const condition = diagnosisData?.diagnosis?.primary?.condition?.toLowerCase() || ''
    const tests = []
    
    if (condition.includes('thorax') || condition.includes('poumon') || condition.includes('angine')) {
      tests.push({
        exam: "Radiographie thoracique face",
        category: "Radiologie conventionnelle",
        indication: "Bilan thoracique de base",
        urgency: "48h",
        preparation: "Retirer bijoux et objets mÃ©talliques",
        mauritianAvailability: "Tous centres de radiologie"
      })
    }
    
    if (condition.includes('cardiaque') || condition.includes('cÅ“ur')) {
      tests.push({
        exam: "ECG 12 dÃ©rivations",
        category: "Exploration fonctionnelle",
        indication: "Ã‰valuation fonction cardiaque",
        urgency: "URGENT",
        preparation: "Aucune",
        mauritianAvailability: "Tous centres mÃ©dicaux"
      })
      
      tests.push({
        exam: "Ã‰chocardiographie transthoracique",
        category: "Ã‰chographie",
        indication: "Ã‰valuation morphologie et fonction cardiaque",
        urgency: "Dans la semaine",
        preparation: "Aucune",
        mauritianAvailability: "Cardiologues et centres spÃ©cialisÃ©s"
      })
    }
    
    if (condition.includes('abdomin')) {
      tests.push({
        exam: "Ã‰chographie abdominale complÃ¨te",
        category: "Ã‰chographie",
        indication: "Exploration abdominale",
        urgency: "48-72h",
        preparation: "Ã€ jeun 6h",
        mauritianAvailability: "Tous centres d'imagerie"
      })
    }
    
    return tests
  }

  static getMauritianBrand(dciName: string): string {
    const brandMap: Record<string, string> = {
      'paracÃ©tamol': 'Panadol, Doliprane',
      'ibuprofÃ¨ne': 'Brufen, Nurofen',
      'amoxicilline': 'Amoxil, Clamoxyl',
      'omÃ©prazole': 'Losec, Mopral',
      'mÃ©tformine': 'Glucophage',
      'amlodipine': 'Amlor, Norvasc',
      'aspirine': 'Aspirin Protect',
      'atorvastatine': 'Lipitor, Tahor'
    }
    
    return brandMap[dciName.toLowerCase()] || 'GÃ©nÃ©rique disponible'
  }

  static getMedicationClass(medicationName: string): string {
    const name = medicationName.toLowerCase()
    
    if (name.includes('cilline') || name.includes('mycine') || name.includes('floxacine')) {
      return 'Antibiotique'
    } else if (name.includes('azole') || name.includes('prazole')) {
      return 'Inhibiteur pompe Ã  protons'
    } else if (name.includes('statine')) {
      return 'HypolipÃ©miant'
    } else if (name.includes('pril') || name.includes('sartan')) {
      return 'Antihypertenseur'
    } else if (name.includes('formine')) {
      return 'AntidiabÃ©tique'
    } else if (name.includes('doliprane') || name.includes('paracÃ©tamol')) {
      return 'Antalgique/AntipyrÃ©tique'
    }
    
    return 'MÃ©dicament'
  }

  static calculateQuantity(medication: any): string {
    if (!medication.dosage || !medication.frequency || !medication.duration) {
      return "QSP traitement"
    }
    
    // Simple calculation logic
    const freq = medication.frequency.toLowerCase()
    const duration = medication.duration.toLowerCase()
    
    let dailyDoses = 1
    if (freq.includes('2') || freq.includes('deux')) dailyDoses = 2
    if (freq.includes('3') || freq.includes('trois')) dailyDoses = 3
    if (freq.includes('4') || freq.includes('quatre')) dailyDoses = 4
    
    let days = 7
    if (duration.includes('10')) days = 10
    if (duration.includes('14')) days = 14
    if (duration.includes('21')) days = 21
    if (duration.includes('mois') || duration.includes('30')) days = 30
    
    const total = dailyDoses * days
    return `${total} comprimÃ©s`
  }

  static getMedicationInstructions(medicationName: string): string {
    const name = medicationName.toLowerCase()
    
    if (name.includes('antibio') || name.includes('cilline')) {
      return "Ã€ prendre pendant toute la durÃ©e prescrite mÃªme si amÃ©lioration"
    } else if (name.includes('prazole')) {
      return "Ã€ prendre 30 min avant le repas"
    } else if (name.includes('aspirine')) {
      return "Ã€ prendre pendant le repas"
    } else if (name.includes('metformine')) {
      return "Ã€ prendre pendant ou aprÃ¨s le repas"
    }
    
    return "Selon prescription"
  }

  static getDefaultMedications(diagnosisData: any): any[] {
    const condition = diagnosisData?.diagnosis?.primary?.condition?.toLowerCase() || ''
    const medications = []
    
    // Pain management (common)
    medications.push({
      dci: "ParacÃ©tamol",
      brand: "Panadol, Doliprane",
      class: "Antalgique/AntipyrÃ©tique",
      dosage: "500mg",
      frequency: "1-2 cp 3 fois par jour",
      duration: "5 jours",
      totalQuantity: "30 comprimÃ©s",
      indication: "Douleur et/ou fiÃ¨vre",
      administration: "Voie orale",
      specialInstructions: "Maximum 4g/jour. Espacer les prises de 6h"
    })
    
    // Condition-specific medications
    if (condition.includes('infection') || condition.includes('angine')) {
      medications.push({
        dci: "Amoxicilline",
        brand: "Amoxil, Clamoxyl",
        class: "Antibiotique Î²-lactamine",
        dosage: "1g",
        frequency: "2 fois par jour",
        duration: "7 jours",
        totalQuantity: "14 comprimÃ©s",
        indication: "Infection bactÃ©rienne probable",
        administration: "Voie orale",
        specialInstructions: "Ã€ prendre pendant les repas. Traitement complet obligatoire"
      })
    }
    
    if (condition.includes('gastro') || condition.includes('reflux')) {
      medications.push({
        dci: "OmÃ©prazole",
        brand: "Losec, Mopral",
        class: "IPP",
        dosage: "20mg",
        frequency: "1 fois par jour le matin",
        duration: "14 jours",
        totalQuantity: "14 gÃ©lules",
        indication: "Protection gastrique",
        administration: "Voie orale",
        specialInstructions: "Ã€ jeun 30 min avant petit-dÃ©jeuner"
      })
    }
    
    return medications
  }

  static getSymptomaticTreatments(diagnosisData: any): any[] {
    const treatments = []
    const symptoms = diagnosisData?.symptoms || []
    
    if (symptoms.some((s: string) => s.toLowerCase().includes('nausÃ©e'))) {
      treatments.push({
        dci: "MÃ©toclopramide",
        brand: "PrimpÃ©ran",
        class: "AntiÃ©mÃ©tique",
        dosage: "10mg",
        frequency: "3 fois par jour si nausÃ©es",
        duration: "3 jours maximum",
        totalQuantity: "9 comprimÃ©s",
        indication: "NausÃ©es",
        administration: "Voie orale",
        specialInstructions: "30 min avant repas. Attention somnolence"
      })
    }
    
    if (symptoms.some((s: string) => s.toLowerCase().includes('toux'))) {
      treatments.push({
        dci: "DextromÃ©thorphane",
        brand: "Tussidane",
        class: "Antitussif",
        dosage: "15mg",
        frequency: "3 fois par jour",
        duration: "5 jours",
        totalQuantity: "15 comprimÃ©s",
        indication: "Toux sÃ¨che",
        administration: "Voie orale",
        specialInstructions: "Ne pas associer avec expectorants"
      })
    }
    
    return treatments
  }
}
